---
title: react-query, typescript vÃ  error response
thumbnail:
  url: >-
    /images/posts/2021-06-01-react-query-typescript-va-error-response/thumbnail/url.webp
  caption: Hai máº£ng led mÃ u xanh
summary: Äau Ä‘áº§u vÃ¬ declare error type? Äá»c ngay bÃ i nÃ y Ä‘á»ƒ trá»‹ dá»©t Ä‘iá»ƒm ğŸ˜
isDraft: false
publishedAt: '2021-06-01'
updatedAt: '2021-06-01'
tags:
  - code-suy
seo:
  discriminant: false
---
Má»™t ngÃ y Ä‘áº¹p trá»i, cÃ´ng ty mÃ¬nh báº¯t Ä‘áº§u má»™t dá»± Ã¡n dÃ¹ng restful thay vÃ¬ `graphql`. Vá»›i sai láº§m cá»§a tuá»•i tráº» lÃ  dÃ¹ng `apollo-client` cho restful hoáº·c tá»± viáº¿t network layer báº±ng `redux`, mÃ¬nh khuyÃªn anh em dÃ¹ng `react-query`. MÃ¬nh cÅ©ng chÆ°a cÃ³ kinh nghiá»‡m ngay lÃºc gá»£i Ã½ nhÆ°ng trÃ´ng `react-query` ráº¥t lÃ  há»©a háº¹n lÃºc mÃ¬nh má»›i phÃ¡t hiá»‡n ra ğŸ¤£ Táº¡i má»™t pháº§n lÃ  Ä‘Æ°á»£c [Kent C. Dodds](https://twitter.com/kentcdodds) giá»›i thiá»‡u nÃªn mÃ¬nh cÅ©ng khÃ¡ lÃ  yÃªn tÃ¢m.

Sau hÆ¡n ná»­a nÄƒm sá»­ dá»¥ng tá»« version 1.x.x thÃ¬ Ä‘iá»ƒm duy nháº¥t mÃ¬nh tháº¥y khÃ³ chá»‹u Ä‘Ã³ lÃ  viá»‡c pháº£i khai bÃ¡o type cho cÃ¡i error response.

BÃ¬nh thÆ°á»ng dÃ¹ng máº¥y cÃ¡i hook cá»§a thÆ° viá»‡n sáº½ nhÆ° nÃ y:

```typescript
function fetchThingById(ctx: QueryFunctionContext<{ id: string }>): Promise<{ id: string; name: string }> {
  const [, { id }] = ctx
  return new Promise((resolve) => resolve({ id, name: id }))
}
const { data, error } = useQuery([UniqueRequetKey, params], fetchThingById)
```

Dá»… pháº£i khÃ´ng? NhÆ°ng ná»‘ ná»“ nÃ´, typescript sáº½ bÃ¡o lÃ  cÃ¡i `error` sáº½ lÃ  `unknown`. So sad! Má»—i khi dÃ¹ng láº¡i pháº£i cast type. KhÃ¡ lÃ  bá»±c luÃ´n ğŸ˜©

VÃ¬ `useQuery` cÃ³ há»— trá»£ generic type, nÃªn muá»‘n quáº¥t cÃ¡i type cho `error` má»™t Ä‘á»“ng nghiá»‡p cá»§a mÃ¬nh chÆ¡i nhÆ° nÃ y:

```typescript
type Response = { id: string; name: string }
type Error = { code: number; message: string }
type Params = { id: string }

function fetchThingById(ctx: QueryFunctionContext<Params>): Promise<Response> {
  const [, { id }] = ctx
  return new Promise((resolve) => resolve({ id, name: id }))
}
const { data, error } = useQuery<Response, Params, Error>([UniqueRequetKey, params], fetchThingById)
```

TrÃ´ng cÅ©ng khÃ´ng Ä‘áº¿n ná»—i tá»‡ pháº£i khÃ´ng? NhÆ°ng tháº­t ra, queryFn `fetchThingById` vÃ  type cá»§a nÃ³ láº¡i náº±m á»Ÿ má»™t nÆ¡i khÃ¡c khÃ´ng chung file vá»›i component dÃ¹ng nÃ³. ChÆ°a ká»ƒ, tÃªn má»™t sá»‘ type nÃ³ khÃ´ng ngáº¯n gá»n nhÆ° váº­y. ThÃ nh ra lÃºc Ä‘á»c code, nhiá»u lÃºc nhÃ¬n chá»‰ tháº¥y type lÃ  type. VÃ  nháº¥t lÃ  tá»± dÆ°ng mÃ¬nh Ä‘Ã£ máº¥t cÃ´ng lÃ m type cho tá»«ng endpoint trong SDK rá»“i. Xong lÃºc dÃ¹ng láº¡i pháº£i `import` thÃªm má»™t láº§n ná»¯a. Cáº£m giÃ¡c khÃ¡ bá»©c xÃºc ğŸ˜© Má»™t vÃ i anh em khÃ¡ lÃ  cáº§n máº«n khai bÃ¡o háº¿t táº¥t cáº£ cÃ¡c thá»ƒ loáº¡i generic type cho cáº£ ba cÃ¡i hooks hay dÃ¹ng luÃ´n. NhÆ°ng mÃ¬nh khÃ´ng chá»‹u, mÃ¬nh Ä‘i tÃ¬m cÃ¡ch Ä‘á»ƒ sá»‘ng dá»… thá»Ÿ hÆ¡n ğŸ¤§

MÃ¬nh chá»‰ muá»‘n define response type lÃºc define endpoint. Error type chá»‰ khai bÃ¡o 1 láº§n thÃ´i. VÃ¬ server cá»§a bÃªn mÃ¬nh luÃ´n chá»‰ tráº£ error theo format Ä‘Ã£ Ä‘Æ°á»£c quy Ä‘á»‹nh trÆ°á»›c.

TÃ¬m gáº§n háº¿t má»™t ngÃ y, quáº«n ghÃª. Äá»‹nh pm twitter há»i author cá»§a `react-query` xem lÃ m nhÆ° nÃ o thÃ¬ ngon. MÃ  mÃ¬nh chá»£t nhá»› ra mÃ¬nh cÃ³ override láº¡i type declaration cá»§a `styled-components` Ä‘á»ƒ há»— trá»£ vá»¥ declare type cho theme object. NÃªn thá»­ luÃ´n vÃ  thÃ nh cÃ´ng má»¹ mÃ£n.

**1. Äáº§u tiÃªn lÃ  táº¡o file declare cho react-query**

```bash
mkdir -p src/types
touch react-query.d.ts
```

**2. Override declaration**

```typescript
import { QueryFunction, QueryKey, UseQueryOptions, UseQueryResult } from 'react-query'

declare module 'react-query' {
  // Magic here!
  type ErrorResponse = {
    code: number
    message: string
  }
  export declare function useQuery<TQueryFnData = unknown, TError = ErrorResponse, TData = TQueryFnData>(
    queryKey: QueryKey,
    queryFn: QueryFunction<TQueryFnData>,
    options?: UseQueryOptions<TQueryFnData, TError, TData>,
  ): UseQueryResult<TData, TError>
}
```

Xong! Giá» chá»‰ viá»‡c nhÃ©t cÃ¡i `queryFn` vÃ o hook lÃ  `error` sáº½ luÃ´n cÃ³ `default type ErrorResponse`. Báº¡n váº«n cÃ³ thá»ƒ Ä‘á»•i láº¡i type khÃ¡c náº¿u request Ä‘áº¥y nÃ³ khÃ´ng tráº£ láº¡i error nhÆ° cÃ¡i default kia báº±ng cÃ¡ch nhÆ° vÃ­ dá»¥ 2 á»Ÿ trÃªn.

NgoÃ i ra báº¡n cÃ³ thá»ƒ sá»­a cho `useInfiniteQuery` vÃ  `useMutation` ná»¯a. VÃ  tuá»³ vÃ o cÃ¡ch cÃ¡c báº¡n dÃ¹ng Ä‘á»ƒ configs máº¥y cÃ¡i hook mÃ  override láº¡i cho Ä‘Ãºng. Äá»ƒ biáº¿t nÃªn override cÃ¡i nÃ o thÃ¬ cÃ¡c báº¡n chui tháº³ng vÃ o file type cá»§a `react-query` mÃ  xem thÃ´i. Hoáº·c khÃ´ng thÃ¬ copy Ä‘á»‘ng overload vá» rá»“i sá»­a háº¿t láº¡i má»™t thá»ƒ luÃ´n ğŸ¤£

Happy coding!
